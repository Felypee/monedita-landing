<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Monedita - Categor√≠as y Presupuestos</title>
    <meta name="description" content="Configura tus categor√≠as de gastos y presupuestos mensuales para Monedita.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        whatsapp: '#25D366',
                        'whatsapp-dark': '#128C7E',
                    }
                }
            }
        }
    </script>
    <style>
        .animated-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }
        .animated-bg::before {
            content: '';
            position: absolute;
            inset: -50%;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite;
        }
        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-5%, 10%); }
        }
        .category-card {
            transition: all 0.2s ease;
        }
        .category-card:hover {
            transform: translateY(-2px);
        }
        .category-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .budget-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="min-h-screen font-sans text-white">
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Main Content -->
    <div class="relative z-10 min-h-screen py-8 px-4">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <span class="text-4xl">üí∞</span>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Monedita
                    </h1>
                </div>
                <p class="text-gray-400" id="subtitle">Configura tus categor√≠as y presupuestos</p>
            </div>

            <!-- Phone Input -->
            <div class="bg-white/5 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/10">
                <label class="block text-sm font-medium text-gray-300 mb-2" id="phone-label">
                    Tu n√∫mero de WhatsApp
                </label>
                <div class="flex gap-2">
                    <select id="country-code" class="bg-white/10 border border-white/20 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-purple-500">
                        <option value="57">üá®üá¥ +57</option>
                        <option value="52">üá≤üáΩ +52</option>
                        <option value="1">üá∫üá∏ +1</option>
                        <option value="34">üá™üá∏ +34</option>
                        <option value="54">üá¶üá∑ +54</option>
                        <option value="55">üáßüá∑ +55</option>
                        <option value="56">üá®üá± +56</option>
                        <option value="51">üáµüá™ +51</option>
                    </select>
                    <input
                        type="tel"
                        id="phone-number"
                        placeholder="300 123 4567"
                        class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                    >
                </div>
                <p class="text-xs text-gray-500 mt-2" id="phone-hint">Ingresa el n√∫mero que usas en WhatsApp</p>
            </div>

            <!-- Categories Section -->
            <div class="bg-white/5 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/10">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2" id="categories-title">
                    <span>üìÇ</span> Selecciona tus categor√≠as
                </h2>

                <div id="categories-container" class="space-y-3">
                    <!-- Categories will be loaded here -->
                </div>

                <!-- Add Custom Category -->
                <div class="mt-6 pt-6 border-t border-white/10">
                    <h3 class="text-sm font-medium text-gray-300 mb-3" id="custom-category-title">‚ûï Agregar categor√≠a personalizada</h3>
                    <div class="flex gap-2 flex-wrap">
                        <input
                            type="text"
                            id="custom-name"
                            placeholder="Nombre"
                            class="flex-1 min-w-[120px] bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                        >
                        <input
                            type="text"
                            id="custom-emoji"
                            placeholder="üéØ"
                            maxlength="2"
                            class="w-14 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:border-purple-500"
                        >
                        <input
                            type="number"
                            id="custom-budget"
                            placeholder="Presupuesto"
                            class="w-28 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                        >
                        <button
                            onclick="addCustomCategory()"
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        >
                            + Agregar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <button
                id="save-button"
                onclick="saveConfiguration()"
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
            >
                <span>üíæ</span>
                <span id="save-button-text">Guardar Configuraci√≥n</span>
            </button>

            <!-- Success Message (hidden by default) -->
            <div id="success-message" class="hidden mt-6 bg-green-500/20 border border-green-500/30 rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">‚úÖ</div>
                <h3 class="text-xl font-semibold text-green-400 mb-2" id="success-title">¬°Configuraci√≥n guardada!</h3>
                <p class="text-gray-300" id="success-text">Ya puedes usar Monedita con tus categor√≠as personalizadas.</p>
                <a
                    id="whatsapp-link"
                    href="#"
                    class="inline-block mt-4 bg-whatsapp hover:bg-whatsapp-dark text-white font-semibold py-3 px-6 rounded-xl transition-colors"
                >
                    <span id="open-whatsapp-text">Abrir WhatsApp</span> ‚Üí
                </a>
            </div>

            <!-- Error Message (hidden by default) -->
            <div id="error-message" class="hidden mt-4 bg-red-500/20 border border-red-500/30 rounded-xl p-4 text-center">
                <p class="text-red-400" id="error-text"></p>
            </div>
        </div>
    </div>

    <script>
        // API endpoint
        const API_URL = 'https://monedita-backend.up.railway.app';
        // const API_URL = 'http://localhost:3000'; // For local testing

        // WhatsApp bot number
        const BOT_NUMBER = '573001234567'; // Replace with actual bot number

        // Default categories by language
        const CATEGORIES = {
            en: [
                { id: 'food', name: 'Food', emoji: 'üçî' },
                { id: 'transport', name: 'Transport', emoji: 'üöó' },
                { id: 'shopping', name: 'Shopping', emoji: 'üõí' },
                { id: 'entertainment', name: 'Entertainment', emoji: 'üé¨' },
                { id: 'bills', name: 'Bills', emoji: 'üìÑ' },
                { id: 'health', name: 'Health', emoji: 'üíä' },
                { id: 'other', name: 'Other', emoji: 'üì¶' },
            ],
            es: [
                { id: 'comida', name: 'Comida', emoji: 'üçî' },
                { id: 'transporte', name: 'Transporte', emoji: 'üöó' },
                { id: 'compras', name: 'Compras', emoji: 'üõí' },
                { id: 'entretenimiento', name: 'Entretenimiento', emoji: 'üé¨' },
                { id: 'servicios', name: 'Servicios', emoji: 'üìÑ' },
                { id: 'salud', name: 'Salud', emoji: 'üíä' },
                { id: 'otros', name: 'Otros', emoji: 'üì¶' },
            ],
            pt: [
                { id: 'comida', name: 'Comida', emoji: 'üçî' },
                { id: 'transporte', name: 'Transporte', emoji: 'üöó' },
                { id: 'compras', name: 'Compras', emoji: 'üõí' },
                { id: 'entretenimento', name: 'Entretenimento', emoji: 'üé¨' },
                { id: 'contas', name: 'Contas', emoji: 'üìÑ' },
                { id: 'saude', name: 'Sa√∫de', emoji: 'üíä' },
                { id: 'outros', name: 'Outros', emoji: 'üì¶' },
            ],
        };

        // UI translations
        const UI = {
            en: {
                subtitle: 'Set up your categories and budgets',
                phoneLabel: 'Your WhatsApp number',
                phoneHint: 'Enter the number you use on WhatsApp',
                categoriesTitle: 'üìÇ Select your categories',
                customCategoryTitle: '‚ûï Add custom category',
                budgetPlaceholder: 'Budget',
                saveButton: 'Save Configuration',
                successTitle: 'Configuration saved!',
                successText: 'You can now use Monedita with your custom categories.',
                openWhatsapp: 'Open WhatsApp',
                errorPhone: 'Please enter a valid phone number',
                errorCategories: 'Please select at least one category',
                errorSave: 'Error saving. Please try again.',
            },
            es: {
                subtitle: 'Configura tus categor√≠as y presupuestos',
                phoneLabel: 'Tu n√∫mero de WhatsApp',
                phoneHint: 'Ingresa el n√∫mero que usas en WhatsApp',
                categoriesTitle: 'üìÇ Selecciona tus categor√≠as',
                customCategoryTitle: '‚ûï Agregar categor√≠a personalizada',
                budgetPlaceholder: 'Presupuesto',
                saveButton: 'Guardar Configuraci√≥n',
                successTitle: '¬°Configuraci√≥n guardada!',
                successText: 'Ya puedes usar Monedita con tus categor√≠as personalizadas.',
                openWhatsapp: 'Abrir WhatsApp',
                errorPhone: 'Por favor ingresa un n√∫mero v√°lido',
                errorCategories: 'Por favor selecciona al menos una categor√≠a',
                errorSave: 'Error al guardar. Por favor intenta de nuevo.',
            },
            pt: {
                subtitle: 'Configure suas categorias e or√ßamentos',
                phoneLabel: 'Seu n√∫mero do WhatsApp',
                phoneHint: 'Digite o n√∫mero que voc√™ usa no WhatsApp',
                categoriesTitle: 'üìÇ Selecione suas categorias',
                customCategoryTitle: '‚ûï Adicionar categoria personalizada',
                budgetPlaceholder: 'Or√ßamento',
                saveButton: 'Salvar Configura√ß√£o',
                successTitle: 'Configura√ß√£o salva!',
                successText: 'Agora voc√™ pode usar o Monedita com suas categorias personalizadas.',
                openWhatsapp: 'Abrir WhatsApp',
                errorPhone: 'Por favor, digite um n√∫mero v√°lido',
                errorCategories: 'Por favor, selecione pelo menos uma categoria',
                errorSave: 'Erro ao salvar. Por favor, tente novamente.',
            },
        };

        // Current language
        let currentLang = 'es';
        let customCategories = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Detect language from URL or browser
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && CATEGORIES[langParam]) {
                currentLang = langParam;
            } else {
                // Detect from browser
                const browserLang = navigator.language.split('-')[0];
                if (CATEGORIES[browserLang]) {
                    currentLang = browserLang;
                }
            }

            // Update UI language
            updateUILanguage();

            // Load categories
            renderCategories();

            // Listen for country code changes to update language
            document.getElementById('country-code').addEventListener('change', (e) => {
                const code = e.target.value;
                if (['57', '52', '34', '54', '56', '51', '58', '593'].includes(code)) {
                    currentLang = 'es';
                } else if (code === '55') {
                    currentLang = 'pt';
                } else {
                    currentLang = 'en';
                }
                updateUILanguage();
                renderCategories();
            });
        });

        function updateUILanguage() {
            const ui = UI[currentLang] || UI.en;
            document.documentElement.lang = currentLang;
            document.getElementById('subtitle').textContent = ui.subtitle;
            document.getElementById('phone-label').textContent = ui.phoneLabel;
            document.getElementById('phone-hint').textContent = ui.phoneHint;
            document.getElementById('categories-title').innerHTML = ui.categoriesTitle;
            document.getElementById('custom-category-title').textContent = ui.customCategoryTitle;
            document.getElementById('save-button-text').textContent = ui.saveButton;
            document.getElementById('success-title').textContent = ui.successTitle;
            document.getElementById('success-text').textContent = ui.successText;
            document.getElementById('open-whatsapp-text').textContent = ui.openWhatsapp;
            document.getElementById('custom-budget').placeholder = ui.budgetPlaceholder;
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            const categories = [...(CATEGORIES[currentLang] || CATEGORIES.en), ...customCategories];
            const ui = UI[currentLang] || UI.en;

            container.innerHTML = categories.map((cat, index) => `
                <div class="category-card bg-white/5 border border-white/10 rounded-xl p-4 flex items-center gap-4" data-id="${cat.id}">
                    <input
                        type="checkbox"
                        id="cat-${cat.id}"
                        class="custom-checkbox"
                        checked
                    >
                    <label for="cat-${cat.id}" class="flex-1 flex items-center gap-3 cursor-pointer">
                        <span class="text-2xl">${cat.emoji}</span>
                        <span class="font-medium">${cat.name}</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">$</span>
                        <input
                            type="number"
                            id="budget-${cat.id}"
                            placeholder="${ui.budgetPlaceholder}"
                            class="budget-input w-28 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500"
                        >
                    </div>
                    ${cat.custom ? `
                        <button onclick="removeCustomCategory('${cat.id}')" class="text-gray-500 hover:text-red-400 transition-colors">
                            ‚úï
                        </button>
                    ` : ''}
                </div>
            `).join('');

            // Add click handler to cards
            container.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = card.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        card.classList.toggle('selected', checkbox.checked);
                    }
                });
            });
        }

        function addCustomCategory() {
            const nameInput = document.getElementById('custom-name');
            const emojiInput = document.getElementById('custom-emoji');
            const budgetInput = document.getElementById('custom-budget');

            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim() || 'üì¶';

            if (!name) return;

            const id = name.toLowerCase().replace(/\s+/g, '_');

            // Check if already exists
            if (customCategories.find(c => c.id === id)) return;

            customCategories.push({
                id,
                name,
                emoji,
                budget: budgetInput.value || null,
                custom: true,
            });

            // Clear inputs
            nameInput.value = '';
            emojiInput.value = '';
            budgetInput.value = '';

            // Re-render
            renderCategories();

            // Set the budget value if provided
            if (budgetInput.value) {
                document.getElementById(`budget-${id}`).value = budgetInput.value;
            }
        }

        function removeCustomCategory(id) {
            customCategories = customCategories.filter(c => c.id !== id);
            renderCategories();
        }

        async function saveConfiguration() {
            const ui = UI[currentLang] || UI.en;
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const saveButton = document.getElementById('save-button');

            // Hide previous errors
            errorDiv.classList.add('hidden');

            // Get phone number
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('phone-number').value.replace(/\D/g, '');

            if (!phoneNumber || phoneNumber.length < 7) {
                errorText.textContent = ui.errorPhone;
                errorDiv.classList.remove('hidden');
                return;
            }

            const fullPhone = countryCode + phoneNumber;

            // Get selected categories with budgets
            const categories = [];
            const allCategories = [...(CATEGORIES[currentLang] || CATEGORIES.en), ...customCategories];

            allCategories.forEach(cat => {
                const checkbox = document.getElementById(`cat-${cat.id}`);
                const budgetInput = document.getElementById(`budget-${cat.id}`);

                if (checkbox && checkbox.checked) {
                    categories.push({
                        id: cat.id,
                        name: cat.name,
                        emoji: cat.emoji,
                        budget: budgetInput.value ? parseFloat(budgetInput.value) : null,
                    });
                }
            });

            if (categories.length === 0) {
                errorText.textContent = ui.errorCategories;
                errorDiv.classList.remove('hidden');
                return;
            }

            // Show loading state
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="animate-spin">‚è≥</span> <span>Guardando...</span>';

            try {
                const response = await fetch(`${API_URL}/api/setup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: fullPhone,
                        categories,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error saving');
                }

                // Show success message
                document.getElementById('success-message').classList.remove('hidden');
                saveButton.classList.add('hidden');

                // Update WhatsApp link
                const whatsappLink = document.getElementById('whatsapp-link');
                whatsappLink.href = `https://wa.me/${BOT_NUMBER}?text=Hola%20Monedita!`;

            } catch (error) {
                console.error('Error:', error);
                errorText.textContent = ui.errorSave;
                errorDiv.classList.remove('hidden');
            } finally {
                // Reset button
                saveButton.disabled = false;
                saveButton.innerHTML = `<span>üíæ</span> <span>${ui.saveButton}</span>`;
            }
        }
    </script>
</body>
</html>
