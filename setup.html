<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Monedita - Categor√≠as y Presupuestos</title>
    <meta name="description" content="Configura tus categor√≠as de gastos y presupuestos mensuales para Monedita.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        whatsapp: '#25D366',
                        'whatsapp-dark': '#128C7E',
                    }
                }
            }
        }
    </script>
    <style>
        .animated-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }
        .animated-bg::before {
            content: '';
            position: absolute;
            inset: -50%;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite;
        }
        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-5%, 10%); }
        }
        .category-card {
            transition: all 0.2s ease;
        }
        .category-card:hover {
            transform: translateY(-2px);
        }
        .category-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="min-h-screen font-sans text-white">
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Loading State -->
    <div id="loading-state" class="relative z-10 min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="text-4xl mb-4 animate-bounce">üí∞</div>
            <p class="text-gray-400">Cargando...</p>
        </div>
    </div>

    <!-- Error State (no token) -->
    <div id="error-state" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4">
        <div class="text-center max-w-md">
            <div class="text-6xl mb-4">üîó</div>
            <h1 class="text-2xl font-bold mb-4" id="error-title">Link inv√°lido o expirado</h1>
            <p class="text-gray-400 mb-6" id="error-description">
                Para configurar tus categor√≠as, escribe "configurar categor√≠as" en WhatsApp y te enviaremos un nuevo link.
            </p>
            <a href="https://wa.me/573001234567?text=configurar%20categor%C3%ADas"
               class="inline-block bg-whatsapp hover:bg-whatsapp-dark text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                Abrir WhatsApp
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden relative z-10 min-h-screen py-8 px-4">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <span class="text-4xl">üí∞</span>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Monedita
                    </h1>
                </div>
                <p class="text-gray-400" id="subtitle">Configura tus categor√≠as y presupuestos</p>
            </div>

            <!-- Categories Section -->
            <div class="bg-white/5 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/10">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2" id="categories-title">
                    <span>üìÇ</span> <span id="categories-label">Selecciona tus categor√≠as</span>
                </h2>

                <div id="categories-container" class="space-y-3">
                    <!-- Categories will be loaded here -->
                </div>

                <!-- Add Custom Category -->
                <div class="mt-6 pt-6 border-t border-white/10">
                    <h3 class="text-sm font-medium text-gray-300 mb-3" id="custom-category-title">‚ûï Agregar categor√≠a personalizada</h3>
                    <div class="flex gap-2 flex-wrap">
                        <input
                            type="text"
                            id="custom-name"
                            placeholder="Nombre"
                            class="flex-1 min-w-[120px] bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                        >
                        <input
                            type="text"
                            id="custom-emoji"
                            placeholder="üéØ"
                            maxlength="2"
                            class="w-14 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:border-purple-500"
                        >
                        <input
                            type="number"
                            id="custom-budget"
                            placeholder="Presupuesto"
                            class="w-28 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                        >
                        <button
                            onclick="addCustomCategory()"
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        >
                            +
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <button
                id="save-button"
                onclick="saveConfiguration()"
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
            >
                <span>üíæ</span>
                <span id="save-button-text">Guardar Configuraci√≥n</span>
            </button>

            <!-- Success Message (hidden by default) -->
            <div id="success-message" class="hidden mt-6 bg-green-500/20 border border-green-500/30 rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">‚úÖ</div>
                <h3 class="text-xl font-semibold text-green-400 mb-2" id="success-title">¬°Configuraci√≥n guardada!</h3>
                <p class="text-gray-300" id="success-text">Ya puedes usar Monedita con tus categor√≠as personalizadas.</p>
            </div>

            <!-- Save Error Message -->
            <div id="save-error" class="hidden mt-4 bg-red-500/20 border border-red-500/30 rounded-xl p-4 text-center">
                <p class="text-red-400" id="save-error-text"></p>
            </div>
        </div>
    </div>

    <script>
        // API endpoint
        const API_URL = 'https://budget-agent-production.up.railway.app';
        // const API_URL = 'http://localhost:3000';

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // UI translations
        const UI = {
            en: {
                subtitle: 'Set up your categories and budgets',
                categoriesLabel: 'Select your categories',
                customCategoryTitle: '‚ûï Add custom category',
                budgetPlaceholder: 'Budget',
                saveButton: 'Save Configuration',
                successTitle: 'Configuration saved!',
                successText: 'You can now use Monedita with your custom categories.',
                errorTitle: 'Invalid or expired link',
                errorDescription: 'To configure your categories, type "configure categories" on WhatsApp and we\'ll send you a new link.',
                errorCategories: 'Please select at least one category',
                errorSave: 'Error saving. Please try again.',
            },
            es: {
                subtitle: 'Configura tus categor√≠as y presupuestos',
                categoriesLabel: 'Selecciona tus categor√≠as',
                customCategoryTitle: '‚ûï Agregar categor√≠a personalizada',
                budgetPlaceholder: 'Presupuesto',
                saveButton: 'Guardar Configuraci√≥n',
                successTitle: '¬°Configuraci√≥n guardada!',
                successText: 'Ya puedes usar Monedita con tus categor√≠as personalizadas.',
                errorTitle: 'Link inv√°lido o expirado',
                errorDescription: 'Para configurar tus categor√≠as, escribe "configurar categor√≠as" en WhatsApp y te enviaremos un nuevo link.',
                errorCategories: 'Por favor selecciona al menos una categor√≠a',
                errorSave: 'Error al guardar. Por favor intenta de nuevo.',
            },
            pt: {
                subtitle: 'Configure suas categorias e or√ßamentos',
                categoriesLabel: 'Selecione suas categorias',
                customCategoryTitle: '‚ûï Adicionar categoria personalizada',
                budgetPlaceholder: 'Or√ßamento',
                saveButton: 'Salvar Configura√ß√£o',
                successTitle: 'Configura√ß√£o salva!',
                successText: 'Agora voc√™ pode usar o Monedita com suas categorias personalizadas.',
                errorTitle: 'Link inv√°lido ou expirado',
                errorDescription: 'Para configurar suas categorias, digite "configurar categorias" no WhatsApp e enviaremos um novo link.',
                errorCategories: 'Por favor, selecione pelo menos uma categoria',
                errorSave: 'Erro ao salvar. Por favor, tente novamente.',
            },
        };

        // Current state
        let currentLang = 'es';
        let customCategories = [];
        let defaultCategories = [];
        let existingBudgets = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                showError('invalid');
                return;
            }

            try {
                // Fetch user's current setup
                const response = await fetch(`${API_URL}/api/setup?token=${token}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.log('Error response:', response.status, errorData);

                    // Show specific error message based on error type
                    if (errorData.error === 'Token expired') {
                        showError('expired');
                    } else if (errorData.error === 'User not found') {
                        showError('user_not_found');
                    } else {
                        showError('invalid');
                    }
                    return;
                }

                const data = await response.json();
                currentLang = data.language || 'es';
                existingBudgets = data.budgets || [];

                // Fetch default categories for language
                const catResponse = await fetch(`${API_URL}/api/setup/categories?lang=${currentLang}`);
                const catData = await catResponse.json();
                defaultCategories = catData.categories;

                // If user has custom categories, use those
                if (data.categories && data.categories.length > 0) {
                    defaultCategories = data.categories;
                }

                // Update UI
                updateUILanguage();
                renderCategories();
                showMain();

            } catch (error) {
                console.error('Error loading setup:', error);
                showError();
            }
        });

        function showError(type = 'invalid') {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');

            const errorTitle = document.getElementById('error-title');
            const errorDesc = document.getElementById('error-description');

            const errors = {
                expired: {
                    en: { title: 'Link expired', desc: 'This link has expired. Type "configure categories" on WhatsApp to get a new link.' },
                    es: { title: 'Link expirado', desc: 'Este link ha expirado. Escribe "configurar categor√≠as" en WhatsApp para obtener uno nuevo.' },
                    pt: { title: 'Link expirado', desc: 'Este link expirou. Digite "configurar categorias" no WhatsApp para obter um novo.' },
                },
                user_not_found: {
                    en: { title: 'User not found', desc: 'Send any message to Monedita on WhatsApp first, then request the setup link again.' },
                    es: { title: 'Usuario no encontrado', desc: 'Primero env√≠a cualquier mensaje a Monedita en WhatsApp, luego pide el link de configuraci√≥n nuevamente.' },
                    pt: { title: 'Usu√°rio n√£o encontrado', desc: 'Primeiro envie qualquer mensagem para Monedita no WhatsApp, depois pe√ßa o link de configura√ß√£o novamente.' },
                },
                invalid: {
                    en: { title: 'Invalid link', desc: 'This link is not valid. Type "configure categories" on WhatsApp to get a valid link.' },
                    es: { title: 'Link inv√°lido', desc: 'Este link no es v√°lido. Escribe "configurar categor√≠as" en WhatsApp para obtener uno v√°lido.' },
                    pt: { title: 'Link inv√°lido', desc: 'Este link n√£o √© v√°lido. Digite "configurar categorias" no WhatsApp para obter um v√°lido.' },
                },
            };

            const lang = currentLang || 'es';
            const errorContent = errors[type]?.[lang] || errors[type]?.es || errors.invalid.es;

            errorTitle.textContent = errorContent.title;
            errorDesc.textContent = errorContent.desc;
        }

        function showMain() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        function updateUILanguage() {
            const ui = UI[currentLang] || UI.es;
            document.documentElement.lang = currentLang;
            document.getElementById('subtitle').textContent = ui.subtitle;
            document.getElementById('categories-label').textContent = ui.categoriesLabel;
            document.getElementById('custom-category-title').textContent = ui.customCategoryTitle;
            document.getElementById('save-button-text').textContent = ui.saveButton;
            document.getElementById('success-title').textContent = ui.successTitle;
            document.getElementById('success-text').textContent = ui.successText;
            document.getElementById('error-title').textContent = ui.errorTitle;
            document.getElementById('error-description').textContent = ui.errorDescription;
            document.getElementById('custom-budget').placeholder = ui.budgetPlaceholder;
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            const categories = [...defaultCategories, ...customCategories];
            const ui = UI[currentLang] || UI.es;

            container.innerHTML = categories.map((cat) => {
                // Find existing budget for this category
                const existingBudget = existingBudgets.find(b => b.category === cat.id);
                const budgetValue = existingBudget ? existingBudget.amount : '';

                return `
                <div class="category-card selected bg-white/5 border border-purple-500/50 rounded-xl p-4 flex items-center gap-4" data-id="${cat.id}">
                    <input
                        type="checkbox"
                        id="cat-${cat.id}"
                        class="custom-checkbox"
                        checked
                    >
                    <label for="cat-${cat.id}" class="flex-1 flex items-center gap-3 cursor-pointer">
                        <span class="text-2xl">${cat.emoji}</span>
                        <span class="font-medium">${cat.name}</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">$</span>
                        <input
                            type="number"
                            id="budget-${cat.id}"
                            value="${budgetValue}"
                            placeholder="${ui.budgetPlaceholder}"
                            class="w-28 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                        >
                    </div>
                    ${cat.custom ? `
                        <button onclick="removeCustomCategory('${cat.id}')" class="text-gray-500 hover:text-red-400 transition-colors">
                            ‚úï
                        </button>
                    ` : ''}
                </div>
            `}).join('');

            // Add click handler to toggle selection
            container.querySelectorAll('.category-card').forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');

                card.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                        updateCardStyle(card, checkbox.checked);
                    }
                });

                checkbox.addEventListener('change', () => {
                    updateCardStyle(card, checkbox.checked);
                });
            });
        }

        function updateCardStyle(card, isSelected) {
            if (isSelected) {
                card.classList.add('selected');
                card.classList.remove('border-white/10');
                card.classList.add('border-purple-500/50');
            } else {
                card.classList.remove('selected');
                card.classList.add('border-white/10');
                card.classList.remove('border-purple-500/50');
            }
        }

        function addCustomCategory() {
            const nameInput = document.getElementById('custom-name');
            const emojiInput = document.getElementById('custom-emoji');
            const budgetInput = document.getElementById('custom-budget');

            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim() || 'üì¶';

            if (!name) return;

            const id = name.toLowerCase().replace(/\s+/g, '_');

            // Check if already exists
            if (customCategories.find(c => c.id === id) || defaultCategories.find(c => c.id === id)) {
                return;
            }

            customCategories.push({
                id,
                name,
                emoji,
                custom: true,
            });

            // Clear inputs
            nameInput.value = '';
            emojiInput.value = '';

            // Re-render
            renderCategories();

            // Set budget if provided
            if (budgetInput.value) {
                document.getElementById(`budget-${id}`).value = budgetInput.value;
                budgetInput.value = '';
            }
        }

        function removeCustomCategory(id) {
            customCategories = customCategories.filter(c => c.id !== id);
            renderCategories();
        }

        async function saveConfiguration() {
            const ui = UI[currentLang] || UI.es;
            const errorDiv = document.getElementById('save-error');
            const errorText = document.getElementById('save-error-text');
            const saveButton = document.getElementById('save-button');

            errorDiv.classList.add('hidden');

            // Collect selected categories
            const categories = [];
            const allCategories = [...defaultCategories, ...customCategories];

            allCategories.forEach(cat => {
                const checkbox = document.getElementById(`cat-${cat.id}`);
                const budgetInput = document.getElementById(`budget-${cat.id}`);

                if (checkbox && checkbox.checked) {
                    categories.push({
                        id: cat.id,
                        name: cat.name,
                        emoji: cat.emoji,
                        budget: budgetInput?.value ? parseFloat(budgetInput.value) : null,
                    });
                }
            });

            if (categories.length === 0) {
                errorText.textContent = ui.errorCategories;
                errorDiv.classList.remove('hidden');
                return;
            }

            // Show loading
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="animate-spin">‚è≥</span>';

            try {
                const response = await fetch(`${API_URL}/api/setup?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories }),
                });

                if (!response.ok) {
                    throw new Error('Save failed');
                }

                // Show success
                document.getElementById('success-message').classList.remove('hidden');
                saveButton.classList.add('hidden');

            } catch (error) {
                console.error('Error:', error);
                errorText.textContent = ui.errorSave;
                errorDiv.classList.remove('hidden');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<span>üíæ</span> <span>${ui.saveButton}</span>`;
            }
        }
    </script>
</body>
</html>
