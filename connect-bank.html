<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conectar Banco - Monedita</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      text-align: center;
    }
    .logo { font-size: 48px; margin-bottom: 16px; }
    h1 { color: #333; font-size: 24px; margin-bottom: 8px; }
    p { color: #666; margin-bottom: 24px; line-height: 1.5; }
    .loading { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error { background: #fee; color: #c00; padding: 16px; border-radius: 8px; margin-top: 16px; }
    .success { background: #e8f5e9; color: #2e7d32; padding: 20px; border-radius: 8px; margin-top: 16px; }
    .success strong { display: block; font-size: 18px; margin-bottom: 8px; }
    .whatsapp-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: #25D366; color: white;
      padding: 12px 24px; border-radius: 8px;
      text-decoration: none; font-weight: 600; margin-top: 16px;
    }
    .whatsapp-btn:hover { background: #128C7E; }
    .security-note { font-size: 12px; color: #888; margin-top: 16px; }
    .connect-btn {
      background: #667eea; color: white; border: none;
      padding: 16px 32px; border-radius: 8px; font-size: 16px;
      font-weight: 600; cursor: pointer; margin-top: 16px;
    }
    .connect-btn:hover { background: #5a6fd6; }
    .debug { font-size: 10px; color: #999; margin-top: 10px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üè¶</div>
    <h1>Conecta tu Banco</h1>
    <p>Vincula tu cuenta bancaria de forma segura para importar tus gastos autom√°ticamente.</p>
    <div id="status"></div>
    <div class="security-note">üîí Conexi√≥n encriptada</div>
  </div>

  <!-- Belvo widget container (required) -->
  <div id="belvo"></div>

  <script>
    const API_URL = 'https://budget-agent-production.up.railway.app';
    const WHATSAPP_NUMBER = '573114740716';
    const statusEl = document.getElementById('status');

    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('phone');
    const sessionId = urlParams.get('session');

    if (!phone && !sessionId) {
      showError('Link inv√°lido. Solicita uno nuevo desde WhatsApp.');
    } else {
      init();
    }

    async function init() {
      showLoading('Preparando conexi√≥n...');

      try {
        // 1. Fetch token
        const response = await fetch(`${API_URL}/api/bank/widget-token?phone=${phone || ''}&session=${sessionId || ''}`, {
          method: 'GET', mode: 'cors', headers: { 'Accept': 'application/json' }
        });
        const data = await response.json();

        if (!response.ok || !data.token) {
          throw new Error(data.error || 'No se pudo obtener el token');
        }

        // 2. Load Belvo SDK dynamically
        showLoading('Cargando widget bancario...');
        await loadBelvoSDK();

        // 3. Show connect button
        statusEl.innerHTML = `
          <button class="connect-btn" onclick="openWidget('${data.token}', '${data.phone || phone}')">
            üè¶ Conectar mi banco
          </button>
          <div class="debug">Token listo ‚úì</div>
        `;

      } catch (error) {
        showError(error.message);
      }
    }

    function loadBelvoSDK() {
      return new Promise((resolve, reject) => {
        if (window.belvoSDK) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.belvo.io/belvo-widget-1-stable.js';
        script.onload = () => {
          setTimeout(resolve, 500); // Wait a bit for SDK to initialize
        };
        script.onerror = () => reject(new Error('No se pudo cargar el widget'));
        document.head.appendChild(script);
      });
    }

    function openWidget(token, userPhone) {
      showLoading('Abriendo conexi√≥n bancaria...');

      try {
        // Debug: log the token
        console.log('Belvo token (first 50):', token?.substring(0, 50));

        const config = {
          // Country configuration
          country_codes: ['CO', 'MX', 'BR'],

          // Callbacks (required)
          callback: (link, institution) => {
            console.log('Belvo success:', link, institution);
            showSuccess(institution);
          },
          onExit: (data) => {
            console.log('Belvo exit:', data);
            if (!data || !data.link) {
              statusEl.innerHTML = `
                <div class="error">Conexi√≥n cancelada</div>
                <button class="connect-btn" onclick="openWidget('${token}', '${userPhone}')">
                  üîÑ Intentar de nuevo
                </button>
              `;
            }
          },
          onEvent: (event) => {
            console.log('Belvo event:', event);
          }
        };

        console.log('Creating widget with config:', config);
        const widget = belvoSDK.createWidget(token, config);
        console.log('Widget created, calling build()...');
        widget.build();
        console.log('Widget build() called');
      } catch (e) {
        console.error('Widget error:', e);
        showError('Error al abrir widget: ' + e.message);
      }
    }

    function showLoading(msg) {
      statusEl.innerHTML = `<div class="loading"><div class="spinner"></div><span>${msg}</span></div>`;
    }

    function showError(msg) {
      statusEl.innerHTML = `
        <div class="error">${msg}</div>
        <a href="https://wa.me/${WHATSAPP_NUMBER}?text=conectar%20banco" class="whatsapp-btn">üì± Solicitar nuevo link</a>
      `;
    }

    function showSuccess(institution) {
      statusEl.innerHTML = `
        <div class="success">
          <strong>‚úÖ ¬°Banco conectado!</strong>
          ${institution || 'Tu banco'} se ha vinculado correctamente.
        </div>
        <a href="https://wa.me/${WHATSAPP_NUMBER}?text=sincronizar%20banco" class="whatsapp-btn">üì± Sincronizar transacciones</a>
      `;
    }
  </script>
</body>
</html>
